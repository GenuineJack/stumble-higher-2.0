<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stumble Higher ‚Äì Frame</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --brand:#FF6D0E; }
    .btn      { @apply inline-flex items-center justify-center text-sm font-semibold rounded-full bg-[color:var(--brand)] px-4 py-2 transition; }
    .btn:hover{ background:#e05f04; }
    #next     { flex:1; font-weight:700; }
  </style>
</head>

<body class="bg-zinc-900 text-white flex flex-col h-screen relative">

  <!-- ‚ú¶ MAIN VIEWPORT -->
  <iframe id="frame" class="flex-1 w-full bg-zinc-800"
          sandbox="allow-scripts allow-same-origin allow-popups"></iframe>

  <!-- ‚ú¶ LOADER -->
  <div id="loader" class="absolute inset-0 hidden items-center justify-center bg-black/40">
    <svg class="animate-spin h-10 w-10" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="4" class="opacity-25" />
      <path d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" fill="white" class="opacity-75" />
    </svg>
  </div>

  <!-- ‚ú¶ INFO + CONTROLS -->
  <div class="bg-zinc-950/80 backdrop-blur-sm p-3 space-y-2">
    <div>
      <h2 id="title" class="font-semibold text-sm truncate"></h2>
      <p  id="desc"  class="text-xs opacity-70 truncate"></p>
    </div>
    <div class="flex items-center gap-2">
      <button id="home"  class="btn">üè†</button>
      <button id="open"  class="btn">üåê</button>
      <button id="next"  class="btn" style="flex:1">STUMBLE&nbsp;HIGHER</button>
      <button id="share" class="btn">üì§</button>
    </div>
  </div>

  <script type="module">
    /* ------------------------------------------------------------- *
     * Helper functions
     * ------------------------------------------------------------- */
    const iframe = document.getElementById('frame');
    const loader = document.getElementById('loader');
    const title  = document.getElementById('title');
    const desc   = document.getElementById('desc');

    const TIMEOUT_MS = 3000;
    let timer = null, cur = null, list = [];

    /** Mobile-UA fetch through server proxy */
    async function fetchViaProxy(url) {
      const r = await fetch('/api/proxy?u=' + encodeURIComponent(url));
      return { ok:r.ok, type:r.headers.get('content-type')||'', html: await r.text() };
    }

    /** Quick mime sniff */
    function classify(type, url) {
      if (/\.pdf$/i.test(url) || type.includes('application/pdf'))     return 'pdf';
      if (type.startsWith('image/'))                                   return 'image';
      if (/vnd\.|msword|excel|powerpoint|epub/i.test(type))            return 'binary';
      return 'html';
    }

    /** Toast helper */
    function toast(msg) {
      const t=document.createElement('div');
      t.textContent=msg;
      t.className="fixed bottom-20 left-1/2 -translate-x-1/2 bg-black/80 text-xs px-4 py-2 rounded";
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),1500);
    }

    /** Random picker w/ no immediate repeats */
    function pick() {
      if (!list.length) return null;
      let r = list[Math.random()*list.length|0];
      while (list.length > 1 && r === cur) r = list[Math.random()*list.length|0];
      return r;
    }

    /* ------------------------------------------------------------- *
     * Core show() with multi-layer fallbacks
     * ------------------------------------------------------------- */
    async function show(res) {
      if (!res) { title.textContent='No resources'; desc.textContent=''; return; }
      cur = res;

      loader.classList.remove('hidden');
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => show(pick()), TIMEOUT_MS);  // auto-skip

      try {
        const { ok, type, html } = await fetchViaProxy(res.url);
        if (!ok) throw new Error('fetch failed');

        switch (classify(type, res.url)) {
          case 'pdf':
            iframe.src = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(res.url)}`;
            break;

          case 'image':
            iframe.srcdoc = `<html><body style="margin:0">
              <img src="/api/proxy?u=${encodeURIComponent(res.url)}" style="width:100%">
            </body></html>`;
            break;

          case 'binary':
            iframe.srcdoc = `<html><body style="font-family:sans-serif;
              display:flex;justify-content:center;align-items:center;height:100%;background:#fafafa">
              <p>File type not viewable.<br><a href="${res.url}" target="_blank">
              Open externally ‚Üó</a></p></body></html>`;
            break;

          default: // HTML
            iframe.srcdoc = html;  // sidestep X-Frame bans
        }

        iframe.onload = () => { loader.classList.add('hidden'); clearTimeout(timer); };
      } catch {
        toast('Couldn‚Äôt load ‚Äì skipping');
        setTimeout(()=>show(pick()), 1500);
      }

      title.textContent = `#${res.id} ‚Äî ${res.title}`;
      desc.textContent  = res.author || res.description || '';
    }

    /* ------------------------------------------------------------- *
     * Buttons
     * ------------------------------------------------------------- */
    home.onclick  = () => location.href = '/';
    open.onclick  = () => cur && window.open(cur.url, '_blank');
    next.onclick  = () => show(pick());
    share.onclick = () => cur && parent.postMessage({type:'compose_cast',
                       text:`Found "${cur.title}" on Stumble Higher ‚Äì ${cur.url}`},'*');

    /* ------------------------------------------------------------- *
     * Start
     * ------------------------------------------------------------- */
    list = (await fetch('/resources.json').then(r=>r.json()).catch(()=>[])).resources || [];
    show(pick());

    // ready signal for Warpcast mini-app shell
    if (parent !== window && window.frame?.sdk?.actions?.ready) frame.sdk.actions.ready();
  </script>
</body>
</html>
