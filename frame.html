<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Stumble Higher – Explore</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--brand:#FF6D0E;}
.btn{ @apply px-4 py-2 rounded-full font-semibold text-sm w-full flex justify-center items-center;}
.btn-brand{background-color:var(--brand);}
.btn-brand:hover{background-color:#e05f04;}
</style>
</head>
<body class="bg-zinc-900 text-white flex flex-col h-screen">
<iframe id="webview" class="flex-1 w-full bg-zinc-800" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>

<!-- Bottom nav -->
<div class="bg-zinc-950/80 backdrop-blur-sm p-3 space-y-2">
  <div class="min-h-[48px]">
    <h2 id="title" class="font-semibold text-sm truncate"></h2>
    <p id="desc" class="text-xs opacity-70 truncate"></p>
  </div>
  <div class="grid grid-cols-4 gap-3">
    <button id="homeBtn" class="btn btn-brand" title="Home">🏠</button>
    <button id="openBtn" class="btn btn-brand" title="Open in tab">🌐</button>
    <button id="stumbleBtn" class="btn btn-brand col-span-1" title="Stumble Higher">STUMBLE HIGHER</button>
    <button id="shareBtn" class="btn btn-brand" title="Share">📤</button>
  </div>
</div>

<script type="module">
const Ready=()=>window.parent.postMessage({type:'ready'},'*');
const ComposeCast=p=>window.parent.postMessage({type:'compose_cast',...p},'*');

let resources=[], current=null;

async function fetchResources(){
  try{
    const data=await fetch('resources.json').then(r=>r.json());
    resources=data.sites||data.Sites||[];
  }catch(e){
    console.error('Fetch error',e);
    alert('Could not load resources.');
  }
}

function randomResource(){
  if(!resources.length) return null;
  let pick=resources[Math.floor(Math.random()*resources.length)];
  while(resources.length>1 && pick===current){
    pick=resources[Math.floor(Math.random()*resources.length)];
  }
  return pick;
}

const webview=document.getElementById('webview');
const titleEl=document.getElementById('title');
const descEl=document.getElementById('desc');

function display(res){
  if(!res) { titleEl.textContent='No resources'; descEl.textContent=''; return;}
  current=res;
  webview.src=res.url;
  titleEl.textContent=res.title;
  descEl.textContent=res.description||'';
}

async function start(){
  await fetchResources();
  display(randomResource());
  if(window.parent!==window) Ready();
}

document.getElementById('stumbleBtn').onclick=()=>display(randomResource());
document.getElementById('openBtn').onclick=()=>current && window.open(current.url,'_blank');
document.getElementById('shareBtn').onclick=()=>current && ComposeCast({text:`Found "${current.title}" on Stumble Higher – ${current.url} #StumbleHigher`});
document.getElementById('homeBtn').onclick=()=>window.location.href='/';

start();
</script>
</body>
</html>
