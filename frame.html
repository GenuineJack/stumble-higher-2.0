<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Stumble Higher â€“ Explore</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--brand:#FF6D0E;}
.btn{@apply px-4 py-2 rounded-full font-semibold text-xs w-full flex justify-center items-center;}
.btn-brand{background-color:var(--brand);}
.btn-brand:hover{background-color:#e05f04;}
</style>
</head>
<body class="bg-zinc-900 text-white flex flex-col h-screen">
<iframe id="webview" class="flex-1 w-full bg-zinc-800" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>

<div class="bg-zinc-950/80 backdrop-blur-sm p-3 space-y-2">
  <div class="min-h-[48px]">
    <h2 id="title" class="font-semibold text-sm truncate"></h2>
    <p id="desc" class="text-xs opacity-70 truncate"></p>
  </div>
  <div class="grid grid-cols-4 gap-3">
    <button id="homeBtn" class="btn btn-brand" title="Home">ğŸ </button>
    <button id="openBtn" class="btn btn-brand" title="Open">ğŸŒ</button>
    <button id="stumbleBtn" class="btn btn-brand" title="Stumble Higher">STUMBLE&nbsp;HIGHER</button>
    <button id="shareBtn" class="btn btn-brand" title="Share">ğŸ“¤</button>
  </div>
</div>

<script type="module">
const Ready=()=>window.parent.postMessage({type:'ready'},'*');
const Compose=p=>window.parent.postMessage({type:'compose_cast',...p},'*');

let resources=[], current=null;

async function loadResources(){
  const data=await fetch('resources.json').then(r=>r.json());
  const arr=Array.isArray(data)?data:(data.resources??data.sites??data.Sites??data.Books??[]);
  resources=arr.map((it,i)=>({
      id:it.id??i+1,
      title:it.title??'Untitled',
      url:it.link||it.url||it.author||'',
      description:it.author?`by ${it.author}`:(it.description||'')
  })).filter(r=>r.url);
}

const iframe=document.getElementById('webview');
const titleEl=document.getElementById('title');
const descEl=document.getElementById('desc');

function proxy(u){return '/api/proxy?u='+encodeURIComponent(u)+'&ua='+encodeURIComponent(navigator.userAgent);}

function pick(){
  if(!resources.length)return null;
  let p=resources[Math.floor(Math.random()*resources.length)];
  while(resources.length>1&&p===current){p=resources[Math.floor(Math.random()*resources.length)];}
  return p;
}

function show(res){
  if(!res){titleEl.textContent='No resources';descEl.textContent='';return;}
  current=res;
  iframe.src=proxy(res.url);
  titleEl.textContent=`#${res.id} â€” ${res.title}`;
  descEl.textContent=res.description||'';
}

document.getElementById('stumbleBtn').onclick=()=>show(pick());
document.getElementById('openBtn').onclick=()=>current&&window.open(current.url,'_blank');
document.getElementById('shareBtn').onclick=()=>current&&Compose({text:`Found "${current.title}" on Stumble Higher â€“ ${current.url} #StumbleHigher`});
document.getElementById('homeBtn').onclick=()=>window.location.href='/';

(async()=>{
  await loadResources();
  show(pick());
  if(window.parent!==window)Ready();
})();
</script>
</body>
</html>
